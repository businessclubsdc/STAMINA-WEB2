<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Formulaire Business Club + Paiement</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Script Touchpoint -->
  <script src="https://touchpay.gutouch.net/touchpayv2/script/touchpaynr/prod_touchpay-0.0.1.js" type="text/javascript"></script>

  <!-- Script EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f9f9f9;
      margin: 0; padding: 10px;
    }
    form {
      background-color: #fff;
      padding: 20px;
      border-radius: 10px;
      max-width: 600px;
      margin: 30px auto;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, select {
      width: 100%; padding: 10px; margin: 5px 0 15px;
      border-radius: 5px; border: 1px solid #ccc;
    }
    button {
      background-color: #007aff; color: white;
      padding: 10px; border: none;
      border-radius: 5px; font-size: 16px;
      cursor: pointer; width: 100%;
    }
    button:hover { background-color: #005bb5; }
    .hidden { display: none; }
    #confirmation-message {
      display: none; text-align: center;
      padding: 20px; font-size: 16px;
    }
  </style>
</head>
<body>

<form id="myForm">
  <input type="hidden" id="MemberID" name="MemberID">

  <label for="name">Nom et prénom :</label>
  <input type="text" id="name" required>

  <label for="gender">Sexe :</label>
  <select id="gender" required>
    <option value=""></option>
    <option value="Homme">Homme</option>
    <option value="Femme">Femme</option>
  </select>

  <label for="birthdate">Date de naissance :</label>
  <input type="date" id="birthdate" required>

  <label for="nationality">Nationalité :</label>
  <input type="text" id="nationality" required>

  <label for="phone">Téléphone :</label>
  <input type="tel" id="phone" required>

  <label for="email">Adresse e-mail :</label>
  <input type="email" id="email" required>

  <label for="education_level">Niveau scolaire :</label>
  <select id="education_level" required>
    <option value=""></option>
    <option value="LICENCE 1">LICENCE 1</option>
    <option value="LICENCE 2">LICENCE 2</option>
    <option value="LICENCE 3">LICENCE 3</option>
    <option value="MASTER 1">MASTER 1</option>
    <option value="MASTER 2">MASTER 2</option>
    <option value="AUTRE">AUTRE</option>
  </select>

  <label for="department">Département scolaire :</label>
  <select id="department" required>
    <option value="ECONOMIE">ECONOMIE</option>
    <option value="IST">IST</option>
    <option value="ESITEC">ESITEC</option>
    <option value="MERCURE">MERCURE</option>
    <option value="IMAP">IMAP</option>
    <option value="UQAM">UQAM</option>
    <option value="DROIT">DROIT</option>
    <option value="PROFESSIONNEL(LE)">PROFESSIONNEL(LE)</option>
    <option value="AUTRE">AUTRE</option>
  </select>

  <label for="school">École :</label>
  <select id="school" required>
    <option value=""></option>
    <option value="SUPDECO">SUPDECO</option>
    <option value="AUTRE">AUTRE</option>
  </select>

  <label for="Job">Département du club :</label>
  <select id="Job" required>
    <option value=""></option>
    <option value="DIGITAL">DIGITAL</option>
    <option value="FINANCE">FINANCE</option>
    <option value="AUTRE">AUTRE</option>
  </select>

  <button type="button" onclick="validateAndPay()">Envoyer et Payer</button>
</form>

<div id="confirmation-message">
  <p>✅ Paiement confirmé et vos informations ont été enregistrées.</p>
</div>

<script>
  /* ================= CONFIG ================= */
  const MAKE_WEBHOOK = "https://hook.us2.make.com/n8jbm3yl7tx6v9f2ua37p1o01n808w7";
  const MERCHANT_ID = "STAMI25753";
  const MERCHANT_TOKEN = "QWCRU6qkjB6BEN7LlAEGFL9cOG9PPkQztmmdv81rgNzPfjQbji";
  const DOMAIN = "endpoint-touchpoint-lwjwunpaq-business-clubs-projects.vercel.app";  // Ton domaine Vercel
  const PAYMENT_AMOUNT = 2;  // 2 F CFA

  // Initialisation EmailJS
  emailjs.init("jDP_quiL9Ze-wptPf");

  /* ================= FONCTION DE VALIDATION ================= */
  function validateAndPay() {
    const requiredFields = ["name", "gender", "birthdate", "nationality", "phone", "email", "education_level", "department", "school", "Job"];
    const allFilled = requiredFields.every(id => document.getElementById(id).value.trim() !== "");
    if (!allFilled) {
      alert("Veuillez remplir tous les champs requis.");
      return;
    }

    const memberID = "M" + Math.floor(10000 + Math.random() * 90000);
    document.getElementById("MemberID").value = memberID;

    // Envoi “En attente” à Make
    const dataPending = collectFormData(memberID, "En attente");
    fetch(MAKE_WEBHOOK, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(dataPending)
    })
    .then(() => {
      console.log("Envoyé à Make (En attente)");
      // Lancer Touchpoint
      calltouchpay(memberID);
    })
    .catch(err => {
      console.error("Erreur vers Make :", err);
    });
  }

  /* ================= CONSTRUCTION DES DONNÉES ================= */
  function collectFormData(memberID, statutPaiement) {
    return {
      MemberID: memberID,
      SubmitDate: new Date().toLocaleString(),
      Name: document.getElementById("name").value,
      Gender: document.getElementById("gender").value,
      BirthDate: document.getElementById("birthdate").value,
      Country: document.getElementById("nationality").value,
      Phone: document.getElementById("phone").value,
      Email: document.getElementById("email").value,
      Educationlevel: document.getElementById("education_level").value,
      Department: document.getElementById("department").value,
      School: document.getElementById("school").value,
      Job: document.getElementById("Job").value,
      StatutPaiement: statutPaiement
    };
  }

  /* ================= TOUCHPOINT ================= */
  function calltouchpay(memberID) {
    try {
      sendPaymentInfos(
        new Date().getTime(),
        MERCHANT_ID,
        MERCHANT_TOKEN,
        DOMAIN,
        '', '',
        PAYMENT_AMOUNT,
        'Dakar', '', '', '', '',
        // Redirection après paiement vers success.html
        https://${DOMAIN}/success.html?memberID=${memberID}
      );
    } catch (err) {
      console.error("Erreur lancement Touchpoint :", err);
    }
  }
</script>

</body>
</html>
